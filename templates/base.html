<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% block head %}{% endblock %}
</head>
<body>
<div>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flashes">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
</div>
<div class="top-nav">
    {% if request.path != '/' %}
        <a href="{{ url_for('index') }}">Home</a>
    {% endif %}
</div>
    {% block body %}{% endblock %}

    <script>
    function toggleTable(characterId, show) {
        const tableDiv = document.getElementById('move-table-' + characterId);
        if (tableDiv) {
            tableDiv.style.display = show ? 'block' : 'none';
        }

        // Clear the Tom Select dropdown filter
        const select = document.getElementById('move-filter-' + characterId);
        if (select && select.tomselect) {
            select.tomselect.clear(true);  // Clears selected values
        }

        // Also reset all move divs to show/hide based on action
        tableDiv.querySelectorAll('div[data-move-id]').forEach(div => {
            div.style.display = show ? 'block' : 'none';
        });
    }
    function toggleVisibility(characterId, buttonElement) {
        const tableDiv = document.getElementById('move-table-' + characterId);
        if (!tableDiv) return;

        // Make sure table is visible
        tableDiv.style.display = 'block';

        // Clear the Tom Select dropdown filter
        const select = document.getElementById('move-filter-' + characterId);
        if (select && select.tomselect) {
            select.tomselect.clear(true);  // Clears selected values
        }

        const moveDivs = tableDiv.querySelectorAll('div[data-move-id]');

        resetToggleButtons(characterId, buttonElement);

        const state = buttonElement.getAttribute('data-state');
        const show = state === 'hidden'; // If it's hidden, we want to show all

        moveDivs.forEach(div => {
            div.style.display = show ? 'block' : 'none';
        });

        // Update button label and state
        buttonElement.textContent = show ? 'Hide All' : 'Show All';
        buttonElement.setAttribute('data-state', show ? 'shown' : 'hidden');
    }
    function filterMoves(characterId) {
        const select = document.getElementById(`move-filter-${characterId}`);
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);

        const tableDiv = document.getElementById(`move-table-${characterId}`);
        tableDiv.style.display = 'block';  // Make sure table shows up

        resetToggleButtons(characterId);

        tableDiv.querySelectorAll(`div[data-move-id]`).forEach(div => {
            div.style.display = selected.includes(div.dataset.moveId) ? 'block' : 'none';
        });
    }
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('select[id^="move-filter-"]').forEach(select => {
                const charId = select.id.replace('move-filter-', '');
                new TomSelect(select, {
                    plugins: ['remove_button'],
                    onChange: () => filterMoves(charId)
                });
            });
            // Get all character IDs from your page (assuming each table has id 'move-table-{characterId}')
            document.querySelectorAll('[id^="move-table-"]').forEach(tableDiv => {
                const characterId = tableDiv.id.replace('move-table-', '');

                const visibleMoves = JSON.parse(localStorage.getItem(`visibleMoves-${characterId}`));
                const tableVisible = localStorage.getItem(`tableVisible-${characterId}`);

                // Restore table visibility
                if (tableVisible) {
                    tableDiv.style.display = tableVisible;
                }

                // Restore moves visibility
                const moveDivs = tableDiv.querySelectorAll('div[data-move-id]');
                moveDivs.forEach(div => {
                    if (visibleMoves && visibleMoves.includes(div.dataset.moveId)) {
                        div.style.display = 'block';
                    } else {
                        div.style.display = 'none';
                    }
                });
            });
        });
        function resetFilter(characterId) {
            const select = document.getElementById(`move-filter-${characterId}`);
            if (select && select.tomselect) {
                // Clear selected values in Tom Select
                select.tomselect.clear(true);
            }

            resetToggleButtons(characterId);

            // Hide all move rows for this character
            const moveRows = document.querySelectorAll(`#move-table-${characterId} div[data-move-id]`);
            moveRows.forEach(div => div.style.display = 'none');
        }
        function toggleMatchupNoteForm(show) {
          const form = document.getElementById('matchup-note-form');
          const display = document.getElementById('matchup-note-display');
          form.style.display = show ? 'block' : 'none';
          display.style.display = show ? 'none' : 'block';

          if (show) {
            const textarea = document.getElementById('matchup-note-textarea');
            if (textarea) {
              resizeTextarea(textarea);
              textarea.focus();
            }
          }
        }
    function toggleNoteForm(moveId) {
            const form = document.getElementById(`note-form-${moveId}`);
            const button = document.getElementById(`toggle-button-${moveId}`);

            const isHidden = form.style.display === 'none' || form.style.display === '';

            if (isHidden) {
                // Show form
                form.style.display = 'block';

                const textarea = form.querySelector('textarea');
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                    textarea.focus();
                }

                // Change button to Cancel
                button.textContent = 'Cancel';
            } else {
                // Hide form and restore original value
                const textarea = form.querySelector('textarea');
                if (textarea && textarea.dataset.original !== undefined) {
                    textarea.value = textarea.dataset.original;
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }

                form.style.display = 'none';

                // Restore button label
                button.textContent = textarea && textarea.value.trim()
                    ? 'Edit Note'
                    : 'Add Note';
            }
        }

        // 🔁 Toggle showing/hiding moves WITH notes
        function toggleMovesWithNotes(characterId, buttonElement) {
            const wrapper = document.querySelector(`#move-table-${characterId} [data-character-id='${characterId}']`);
            const tableDiv = document.getElementById(`move-table-${characterId}`);
            if (!wrapper) return;

            // ✅ Always show the table before logic runs
            tableDiv.style.display = 'block';

            // Clear the Tom Select dropdown filter
            const select = document.getElementById('move-filter-' + characterId);
            if (select && select.tomselect) {
                select.tomselect.clear(true);  // Clears selected values
            }

            const moveDivs = wrapper.querySelectorAll('[data-move-id]');

            resetToggleButtons(characterId, buttonElement);

            const show = buttonElement.getAttribute('data-state') === 'hidden';

            moveDivs.forEach(div => {
                const moveId = div.getAttribute('data-move-id');
                const noteDisplay = document.getElementById(`note-display-${moveId}`);
                const hasNote = noteDisplay && noteDisplay.querySelector('li');
                div.style.display = hasNote && show ? 'block' : 'none';
            });

            // Update button label and state
            buttonElement.textContent = show ? 'Hide Moves With Notes' : 'Show Moves With Notes';
            buttonElement.setAttribute('data-state', show ? 'shown' : 'hidden');
        }

        // 🔁 Toggle showing/hiding moves WITHOUT notes
        function toggleMovesWithoutNotes(characterId, buttonElement) {
            const wrapper = document.querySelector(`#move-table-${characterId} [data-character-id='${characterId}']`);
            const tableDiv = document.getElementById(`move-table-${characterId}`);
            if (!wrapper) return;

            // ✅ Always show the table before logic runs
            tableDiv.style.display = 'block';

            // Clear the Tom Select dropdown filter
            const select = document.getElementById('move-filter-' + characterId);
            if (select && select.tomselect) {
                select.tomselect.clear(true);  // Clears selected values
            }

            const moveDivs = wrapper.querySelectorAll('[data-move-id]');

            resetToggleButtons(characterId, buttonElement);

            const show = buttonElement.getAttribute('data-state') === 'hidden';

            moveDivs.forEach(div => {
                const moveId = div.getAttribute('data-move-id');
                const noteDisplay = document.getElementById(`note-display-${moveId}`);
                const hasNote = noteDisplay && noteDisplay.querySelector('li');
                div.style.display = !hasNote && show ? 'block' : 'none';
            });

            // Update button label and state
            buttonElement.textContent = show ? 'Hide Moves Without Notes' : 'Show Moves Without Notes';
            buttonElement.setAttribute('data-state', show ? 'shown' : 'hidden');
        }
    function resetToggleButtons(characterId, exceptButton = null) {
            const buttons = document.querySelectorAll(
                `button[data-state][onclick*="'${characterId}'"]`
            );

            buttons.forEach(btn => {
                if (btn !== exceptButton) {
                    if (btn.textContent.includes('Hide')) {
                        btn.textContent = btn.textContent.replace('Hide', 'Show');
                    }
                    btn.setAttribute('data-state', 'hidden');
                }
            });
        }
        function saveUIState(characterId) {
            const tableDiv = document.getElementById('move-table-' + characterId);
            const moveDivs = tableDiv.querySelectorAll('div[data-move-id]');

            // Save which moves are visible (by moveId)
            const visibleMoves = [];
            moveDivs.forEach(div => {
                if (div.style.display !== 'none') {
                    visibleMoves.push(div.dataset.moveId);
                }
            });

            // Save visible moves array under a key
            localStorage.setItem(`visibleMoves-${characterId}`, JSON.stringify(visibleMoves));

            // Save the visibility of the entire table (block or none)
            localStorage.setItem(`tableVisible-${characterId}`, tableDiv.style.display);

            // Save any other relevant UI state here (e.g. filters, buttons states)
        }
    </script>



<!-- Tom Select CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
</body>
</html>