<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% block head %}{% endblock %}
</head>
<body>
<div>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flashes">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
</div>
<div class="top-nav">
    {% if request.path != '/' %}
        <a href="{{ url_for('index') }}">Home</a>
    {% endif %}
</div>
    {% block body %}{% endblock %}

    <script>
    function toggleTable(characterId, show) {
        const tableDiv = document.getElementById('move-table-' + characterId);
        if (tableDiv) {
            tableDiv.style.display = show ? 'block' : 'none';
        }

        // Clear the Tom Select dropdown filter
        const select = document.getElementById('move-filter-' + characterId);
        if (select && select.tomselect) {
            select.tomselect.clear(true);  // Clears selected values
        }

        // Also reset all move divs to show/hide based on action
        tableDiv.querySelectorAll('div[data-move-id]').forEach(div => {
            div.style.display = show ? 'block' : 'none';
        });
    }
    function toggleVisibility(characterId, buttonElement) {
        const tableDiv = document.getElementById('move-table-' + characterId);
        if (!tableDiv) return;

        // Make sure table is visible
        tableDiv.style.display = 'block';

        const moveDivs = tableDiv.querySelectorAll('div[data-move-id]');

        const state = buttonElement.getAttribute('data-state');
        const show = state === 'hidden'; // If it's hidden, we want to show all

        moveDivs.forEach(div => {
            div.style.display = show ? 'block' : 'none';
        });

        // Update button label and state
        buttonElement.textContent = show ? 'Hide All' : 'Show All';
        buttonElement.setAttribute('data-state', show ? 'shown' : 'hidden');
    }
    function filterMoves(characterId) {
        const select = document.getElementById(`move-filter-${characterId}`);
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);

        const tableDiv = document.getElementById(`move-table-${characterId}`);
        tableDiv.style.display = 'block';  // Make sure table shows up

        tableDiv.querySelectorAll(`div[data-move-id]`).forEach(div => {
            div.style.display = selected.includes(div.dataset.moveId) ? 'block' : 'none';
        });
    }
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('select[id^="move-filter-"]').forEach(select => {
                const charId = select.id.replace('move-filter-', '');
                new TomSelect(select, {
                    plugins: ['remove_button'],
                    onChange: () => filterMoves(charId)
                });
            });
        });
        function resetFilter(characterId) {
            const select = document.getElementById(`move-filter-${characterId}`);
            if (select && select.tomselect) {
                // Clear selected values in Tom Select
                select.tomselect.clear(true);
            }

            // Hide all move rows for this character
            const moveRows = document.querySelectorAll(`#move-table-${characterId} div[data-move-id]`);
            moveRows.forEach(div => div.style.display = 'none');
        }
        function toggleMatchupNoteForm(show) {
          const form = document.getElementById('matchup-note-form');
          const display = document.getElementById('matchup-note-display');
          form.style.display = show ? 'block' : 'none';
          display.style.display = show ? 'none' : 'block';

          if (show) {
            const textarea = document.getElementById('matchup-note-textarea');
            if (textarea) {
              resizeTextarea(textarea);
              textarea.focus();
            }
          }
        }
        function toggleNoteForm(moveId) {
            const form = document.getElementById(`note-form-${moveId}`);
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';

                const textarea = form.querySelector('textarea');
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                    textarea.focus();
                }
            } else {
                form.style.display = 'none';
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            const textareas = document.querySelectorAll('textarea');

            textareas.forEach(function (textarea) {
                const resize = () => {
                    textarea.style.height = 'auto'; // Reset height
                    textarea.style.height = textarea.scrollHeight + 'px'; // Set to scroll height
                };

                // Initial resize
                resize();

                // Resize on input
                textarea.addEventListener('input', resize);
            });
        });
        function cancelMoveNoteForm(moveId) {
            const form = document.getElementById(`note-form-${moveId}`);
            const textarea = form.querySelector('textarea');

            // Restore original content
            if (textarea && textarea.dataset.original !== undefined) {
                textarea.value = textarea.dataset.original;

                // Resize after restoring content
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }

            // Hide the form
            form.style.display = 'none';
        }
        function showMovesWithNotes(characterId) {
            const wrapper = document.querySelector(`#move-table-${characterId} [data-character-id='${characterId}']`);
            if (!wrapper) return;

            wrapper.querySelectorAll('[data-move-id]').forEach(div => {
                const moveId = div.getAttribute('data-move-id');
                const noteDisplay = document.getElementById(`note-display-${moveId}`);
                const hasNote = noteDisplay && noteDisplay.querySelector('li');
                div.style.display = hasNote ? 'block' : 'none';
            });

            // Ensure the whole move table is visible
            const tableDiv = document.getElementById(`move-table-${characterId}`);
            if (tableDiv) {
                tableDiv.style.display = 'block';
            }
        }
        function showMovesWithoutNotes(characterId) {
            const wrapper = document.querySelector(`#move-table-${characterId} [data-character-id='${characterId}']`);
            if (!wrapper) return;

            wrapper.querySelectorAll('[data-move-id]').forEach(div => {
                const moveId = div.getAttribute('data-move-id');
                const noteDisplay = document.getElementById(`note-display-${moveId}`);
                const hasNote = noteDisplay && noteDisplay.querySelector('li');
                div.style.display = hasNote ? 'none' : 'block';
            });

            // Ensure the whole move table is visible
            const tableDiv = document.getElementById(`move-table-${characterId}`);
            if (tableDiv) {
                tableDiv.style.display = 'block';
            }
        }
    </script>



<!-- Tom Select CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
</body>
</html>